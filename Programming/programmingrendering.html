

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Rendering Techniques within trueSKY &mdash; Simul  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Performance" href="programmingprofiling.html" />
    <link rel="prev" title="Programming Guide" href="../programmingindex.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Simul
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation and Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorialsindex.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unrealindex.html">trueSKY for Unreal Engine 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unityindex.html">trueSKY for Unity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sdk.html">trueSKY SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../skysequencer.html">Simul Sky Sequencer</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../programmingindex.html">Programming Guide</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Rendering Techniques within trueSKY</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#clouds">Clouds</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cosmic-background">Cosmic Background</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sun-and-stars">Sun and Stars</a></li>
<li class="toctree-l3"><a class="reference internal" href="#planets">Planets</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sky-and-atmospherics">Sky and Atmospherics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#performance">Performance</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rain-and-snow">Rain and Snow</a></li>
<li class="toctree-l3"><a class="reference internal" href="#shaders">Shaders</a></li>
<li class="toctree-l3"><a class="reference internal" href="#constant-buffers">Constant Buffers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mixed-resolution-rendering">Mixed Resolution Rendering</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-truesky-s-compositor-for-other-things">Using trueSKY’s compositor for other things</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="programmingprofiling.html">Performance</a></li>
<li class="toctree-l2"><a class="reference internal" href="programmingdebugging.html">Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="programmingdeployment.html">trueSKY Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="programminginterface.html">Plugin Rendering Interface</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../legalindex.html">trueSKY Licences</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../API/apiindex.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Reference/referenceindex.html">Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Simul</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../programmingindex.html">Programming Guide</a> &raquo;</li>
        
      <li>Rendering Techniques within trueSKY</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/Programming/programmingrendering.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="rendering-techniques-within-truesky">
<h1>Rendering Techniques within trueSKY<a class="headerlink" href="#rendering-techniques-within-truesky" title="Permalink to this headline">¶</a></h1>
<p>All Simul’s default renderers use a right-handed co-ordinate system with x pointing East, y North, and z up. All units of distance are metres or kilometres. If not specified as km, distance is in metres. Angular units are radians, unless specified as degrees. Temperature is in kelvins, unless specified as degrees Celsius.</p>
<p>Weather Rendering is handled by <a class="reference internal" href="../Reference/Clouds/baseweatherrenderer.html"><span class="doc">BaseWeatherRenderer</span></a>.
The Weather Renderer owns and manages renderers for sky, clouds, atmospherics and other effects.
So the Weather Renderer is the main interface between your program and trueSKY.</p>
<div class="section" id="clouds">
<h2>Clouds<a class="headerlink" href="#clouds" title="Permalink to this headline">¶</a></h2>
<p>The cloud keyframer is updated from <a class="reference internal" href="../Reference/Clouds/environment.html"><span class="doc">Environment</span></a>.</p>
<p>Some <a class="reference internal" href="../Reference/Clouds/cloudkeyframe.html"><span class="doc">CloudKeyframe</span></a> properties are used as per-keyframe values to generated the cloud textures.
These textures are then interpolated for rendering:</p>
<p>Clouds are usually drawn to a pair of lower-resolution buffers.
The <a class="reference internal" href="../Reference/Clouds/cloudrenderer.html"><span class="doc">CloudRenderer</span></a> keeps the cloud volume textures up to date, and draws the clouds volumetrically.</p>
</div>
<div class="section" id="cosmic-background">
<h2>Cosmic Background<a class="headerlink" href="#cosmic-background" title="Permalink to this headline">¶</a></h2>
<p>The cosmic background texture is drawn first, at an orientation that corresponds to the plane of the Milky Way galaxy - see <a class="reference internal" href="../Reference/Sky/skykeyframer.html"><span class="doc">SetBackgroundBrightness</span></a>.</p>
<p>It uses a plate-carree projection, aligned with the galactic horizon. Given the vector “view”, which is the direction in galactic co-ordinates, the calculation is:
.. code-block:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*</span><span class="nb">float</span> <span class="n">az</span>       <span class="o">=</span><span class="n">atan2</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="o">-</span><span class="n">view</span><span class="o">.</span><span class="n">x</span><span class="p">);</span><span class="o">*</span>
<span class="o">*</span><span class="n">vec2</span> <span class="n">texcoord</span>  <span class="o">=</span><span class="n">vec2</span><span class="p">((</span><span class="n">ang</span><span class="o">/</span><span class="p">(</span><span class="n">pi</span><span class="o">*</span><span class="mf">2.0</span><span class="p">)),</span><span class="mf">0.5</span><span class="o">-</span><span class="n">asin</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">z</span><span class="p">)</span><span class="o">/</span><span class="n">pi</span><span class="p">);</span><span class="o">*</span>
</pre></div>
</div>
<p>i.e. the x coordinate is proportional to the azimuth, and the y coordinate is proportional to the elevation</p>
<img alt="../_images/MilkyWay.png" src="../_images/MilkyWay.png" />
<p>You may see some stretching at the top and bottom of the image due to degeneracy of the projection, so it is preferable to have the texture fade to black at the top and bottom edges.</p>
</div>
<div class="section" id="sun-and-stars">
<h2>Sun and Stars<a class="headerlink" href="#sun-and-stars" title="Permalink to this headline">¶</a></h2>
<p>The sun is drawn after the stars.</p>
<p>Stars are drawn as point sprites, and spun around the axis of the Earth’s rotation, in the same direction as the sun. Stars are usually drawn to the highest-resolution buffer (i.e. the frame buffer or final buffer). See
<a class="reference internal" href="../Reference/Sky/skykeyframer.html"><span class="doc">StarBrightness and MaxStarMagnitude</span></a>.</p>
</div>
<div class="section" id="planets">
<h2>Planets<a class="headerlink" href="#planets" title="Permalink to this headline">¶</a></h2>
<p>Planets (e.g. the Moon) are drawn by BaseSkyRenderer.
A planet texture map needs to be supplied, and the shader takes a sun direction as a parameter -
this is used to light the planet (e.g. phases of the moon). Like stars, planets are usually drawn to the
highest-resolution buffer, in order to make sure they have sharp outlines.</p>
</div>
<div class="section" id="sky-and-atmospherics">
<h2>Sky and Atmospherics<a class="headerlink" href="#sky-and-atmospherics" title="Permalink to this headline">¶</a></h2>
<p>The sky and atmospherics are drawn to a volumetric texture for which the x and y axes are screen coordinates, and the z axis is distance. The final compositing step puts the sky, atmospherics and clouds to the current
rendertarget.</p>
</div>
<div class="section" id="performance">
<h2>Performance<a class="headerlink" href="#performance" title="Permalink to this headline">¶</a></h2>
<p>Rendering performance is mostly dependent on the number of pixels drawn, and the number of raycasting steps (or Cloud Slices).
Calculation performance - mainly cloud lighting - depends strongly on the grid size - the larger the grid, the more time will be taken to light a cloud keyframe.</p>
<p>It is usual to downsample the cloud part of the sky rendering, controlled by MaximumCubemapResolution in the <span class="xref std std-doc">CloudRenderingOptions</span>.</p>
<p>Go to our <a class="reference internal" href="programmingprofiling.html"><span class="doc">performance page</span></a> to learn more about how to monitor trueSKY’s performance, along with ways to improve it.</p>
</div>
<div class="section" id="rain-and-snow">
<h2>Rain and Snow<a class="headerlink" href="#rain-and-snow" title="Permalink to this headline">¶</a></h2>
<p>The precipitation is used to control the amount of rain or snowfall at a given time, whilst the PrecipitationThresholdKm property is used to set the thickness of cloud required for rain to fall (setting this to 0 will allow even the smallest of clouds to produce rain). To switch between snow and rain use rain_to_snow (where 0 is rain, 1 is snow).</p>
<p>Each cloud keyframe has a <a class="reference internal" href="../Reference/Clouds/cloudkeyframe.html"><span class="doc">PrecipitationRegion</span></a>, which defines the local area of precipitation,
if it is not global for the keyframe. The amount of particles used for precipitation can be altered with the <a class="reference internal" href="../Reference/Clouds/precipitationrenderer.html"><span class="doc">MaxParticles</span></a> property.</p>
<img alt="../_images/Lightning-RainStreaks.jpg" src="../_images/Lightning-RainStreaks.jpg" />
<p>Classes derived from simul::clouds::BasePrecipitationRenderer are used to draw the rain or snow particles, while the link simul::clouds::PrecipitationRegion rain streak effectendlink is drawn by the cloud renderer. This class has a property “UseSimulationTime” which determines whether rain and snow speed is based on the simulated time-of-day, or real time in seconds.</p>
</div>
<div class="section" id="shaders">
<h2>Shaders<a class="headerlink" href="#shaders" title="Permalink to this headline">¶</a></h2>
<p>trueSKY uses <em>effects</em> for rendering. An effect is a collection of shaders - vertex shaders, pixel shaders and so on, along with information on
how to combine them, how to set render state when they are used, and what inputs they take.</p>
<p>Platform-specific derived classes of link simul::crossplatform::Effect Effectendlink are created with link simul::crossplatform::RenderPlatform::CreateEffect RenderPlatform::CreateEffectendlink,
usually with an extensionless filename passed to the function.</p>
<p>The RenderPlatform first looks for a platform-specific shader source file by appending its platform shader file extension - .fx effect files for DirectX,
.glfx files for GLSL etc. If this is not found, the cross-platform .sfx extension is appended.</p>
<p>The #include directive has been enabled - DirectX handles this by design; while Simul has implemented #include for GLSL. Platform-specific include files have the suffix .hlsl, .glsl, etc., while cross-platform includes have extension .sl.</p>
<p>As far as possible, the functional aspects of shading are defined
in cross-platform shader include files, which have been given the .sl suffix,
and can be found in the Simul/Platform/CrossPlatform/SL directory.</p>
<p>In order for the different shader languages to use these common files, each
platform has a special file that is included before any .sl files, and which
contains definitions needed for the .sl files, including macros and functions - see CppHlsl.hlsl, etc.</p>
</div>
<div class="section" id="constant-buffers">
<h2>Constant Buffers<a class="headerlink" href="#constant-buffers" title="Permalink to this headline">¶</a></h2>
<p>Older versions of GLSL, and DirectX 9, pass constants to shaders individually.
.. code-block:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="ow">in</span> <span class="n">HLSL</span><span class="p">)</span>
<span class="nb">float</span> <span class="n">brightness</span><span class="p">;</span>

<span class="p">(</span><span class="ow">in</span> <span class="n">C</span><span class="o">++</span><span class="p">)</span>
<span class="n">D3DXHANDLE</span> <span class="n">h</span><span class="o">=</span><span class="n">effect</span><span class="o">-&gt;</span><span class="n">GetParameterByName</span><span class="p">(</span><span class="n">NULL</span><span class="p">,</span><span class="s2">&quot;brightness&quot;</span><span class="p">);</span>
<span class="n">effect</span><span class="o">-&gt;</span><span class="n">SetFloat</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mf">1.0</span><span class="p">);</span>
</pre></div>
</div>
<p>OpenGL 3.0 and DirectX 11 have the capability to use em constant em buffers instead,
so if we define in the shader:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="ow">in</span> <span class="n">GLSL</span><span class="p">)</span>
<span class="n">layout</span><span class="p">(</span><span class="n">std140</span><span class="p">)</span> <span class="n">uniform</span> <span class="n">ShaderConstants</span>
<span class="p">{</span>
        <span class="n">uniform</span> <span class="nb">float</span> <span class="n">brightness</span><span class="p">;</span>
        <span class="n">uniform</span> <span class="nb">float</span> <span class="n">gamma</span><span class="p">;</span>
        <span class="n">uniform</span> <span class="nb">float</span> <span class="n">bloom</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>etc., and in C++:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">struct</span> <span class="n">ShaderConstants</span>
<span class="p">{</span>
        <span class="nb">float</span> <span class="n">brightness</span><span class="p">;</span>
        <span class="n">uniform</span> <span class="nb">float</span> <span class="n">gamma</span><span class="p">;</span>
        <span class="n">uniform</span> <span class="nb">float</span> <span class="n">bloom</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>it is then possible to set the values of the whole structure in C++, and pass it complete to the shader. For cross-platform constant buffers, we define:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SIMUL_CONSTANT_BUFFER</span>

<span class="n">SIMUL_CONSTANT_BUFFER_END</span>
</pre></div>
</div>
<p>and these macros have different expansions depending on whether the header is being used in C++, or in a shader compilation.</p>
</div>
<div class="section" id="mixed-resolution-rendering">
<h2>Mixed Resolution Rendering<a class="headerlink" href="#mixed-resolution-rendering" title="Permalink to this headline">¶</a></h2>
<p>TrueSKY’s cloud rendering is usually performed at below the full resolution of the screen. This is because, as a raytracing system, its
efficiency is highly dependent on the number of pixels drawn. To draw at 1/4 the full resolution, for example means rendering 1/16th the
number of pixels, with significant time savings.</p>
<p>However, clouds and Simul’s other volumetric effects can be blended seamlessly with the full-resolution scene, even taking into account MSAA
anti-aliasing. To do this, trueSKY uses a mixed-resolution compositor.</p>
<img alt="../_images/Compositing.png" src="../_images/Compositing.png" />
<p><em>Mixed-resolution compositing in trueSKY</em></p>
<p>The downscaling is set as a property of the weather renderer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">weatherRenderer</span><span class="o">-&gt;</span><span class="n">SetDownscale</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
</pre></div>
</div>
<p>The depth values passed to the weather renderer in your depth texture are processed to obtain the needed information for the compositing. This processing uses the projection matrix passed in in your DeviceContext object. The most efficient projection is usually the depth-reversed style, for which the far plane is at z=0.</p>
</div>
<div class="section" id="using-truesky-s-compositor-for-other-things">
<h2>Using trueSKY’s compositor for other things<a class="headerlink" href="#using-truesky-s-compositor-for-other-things" title="Permalink to this headline">¶</a></h2>
<p>trueSKY’s mixed-resolution compositor can be useful for blending other effects, like particle systems, into the scene.
To do this, you can adapt RenderMixedResolution, or the function it calls, RenderLowResolutionElements. You will need to fill in two rendertargets: one for the far depth, one for the near.</p>
<p>For the far pass, use the x-component of the lowResDepthTexture as depth. For the near pass, use the y-component, but discard fragments whenever the z-component is zero (z represents edges).</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="programmingprofiling.html" class="btn btn-neutral float-right" title="Performance" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../programmingindex.html" class="btn btn-neutral float-left" title="Programming Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2007-2021, Simul Software Ltd.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>